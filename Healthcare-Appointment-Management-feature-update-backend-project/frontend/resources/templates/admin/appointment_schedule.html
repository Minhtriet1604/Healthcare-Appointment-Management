<!-- admin/appointment schedule.html -->

<div th:fragment="content">
    <div class="container-fluid">
        <!-- Tiêu đề -->
        <h2 class="text-danger mb-4">
            <i class="fas fa-calendar-check mr-2"></i> Quản Lý Lịch Khám
        </h2>

        <!-- Form Thêm / Sửa Lịch Khám (dùng card cho đẹp) -->
        <div class="card card-primary card-outline mb-4">
            <div class="card-header">
                <h3 class="card-title">Thêm Lịch Khám</h3>
            </div>
            <div class="card-body">
                <form th:object="${appointmentForm}" th:action="@{/admin/appointments/save}" method="post">
                    <!-- Bệnh nhân -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Bệnh nhân</label>
                            <select class="form-select" th:field="*{patientId}">
                                <option value="">Chọn bệnh nhân</option>
                                <option th:each="patient : ${patients}"
                                        th:value="${patient.id}"
                                        th:text="${patient.fullName}"></option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Bác sĩ</label>
                            <select class="form-select" th:field="*{doctorId}">
                                <option value="">Chọn bác sĩ</option>
                                <option th:each="doctor : ${doctors}"
                                        th:value="${doctor.id}"
                                        th:text="${doctor.fullName}"></option>
                            </select>
                        </div>
                    </div>

                    <!-- Khoa & Phòng (có thể load động phòng theo khoa bằng JS sau) -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Khoa</label>
                            <select class="form-select" th:field="*{departmentId}" id="departmentSelect">
                                <option value="">Chọn khoa</option>
                                <option th:each="dept : ${departments}"
                                        th:value="${dept.id}"
                                        th:text="${dept.name}"></option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phòng</label>
                            <select class="form-select" th:field="*{roomId}" id="roomSelect">
                                <option value="">Chọn phòng</option>
                                <!-- Phòng load động từ backend hoặc JS -->
                                <option th:each="room : ${rooms}" th:value="${room.id}" th:text="${room.name}"></option>
                            </select>
                        </div>
                    </div>

                    <!-- Ngày & Giờ + Loại lịch -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Ngày khám</label>
                            <input type="date" class="form-control" th:field="*{appointmentDate}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Giờ khám</label>
                            <input type="time" class="form-control" th:field="*{appointmentTime}">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Loại lịch khám</label>
                            <select class="form-select" th:field="*{appointmentType}">
                                <option value="KHAM_BENH">Khám bệnh</option>
                                <option value="TAI_KHAM">Tái khám</option>
                                <option value="KHAC">Khác</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Trạng thái</label>
                            <select class="form-select" th:field="*{status}">
                                <option value="PENDING">Chờ xác nhận</option>
                                <option value="CONFIRMED">Đã xác nhận</option>
                                <option value="COMPLETED">Hoàn thành</option>
                                <option value="CANCELLED">Đã hủy</option>
                            </select>
                        </div>
                    </div>

                    <!-- Triệu chứng -->
                    <div class="mb-3">
                        <label class="form-label">Triệu chứng</label>
                        <textarea class="form-control" rows="3" th:field="*{symptoms}" placeholder="Mô tả triệu chứng..."></textarea>
                    </div>

                    <!-- Nút Lưu -->
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save mr-2"></i> Lưu
                    </button>
                </form>
            </div>
        </div>

        <!-- Bảng Danh sách lịch khám (dùng DataTables cho đẹp và chức năng) -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Danh sách lịch khám</h3>
            </div>
            <div class="card-body table-responsive">
                <table class="table table-bordered table-hover" id="appointmentTable">
                    <thead class="table-primary">
                        <tr>
                            <th>Mã</th>
                            <th>Bệnh nhân</th>
                            <th>Bác sĩ</th>
                            <th>Khoa</th>
                            <th>Phòng</th>
                            <th>Ngày</th>
                            <th>Loại</th>
                            <th>Triệu chứng</th>
                            <th>Trạng thái</th>
                            <th>Ngày tạo</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="appt : ${appointments}" th:if="${not #lists.isEmpty(appointments)}">
                            <td th:text="${appt.id}"></td>
                            <td th:text="${appt.patientName}"></td>
                            <td th:text="${appt.doctorName}"></td>
                            <td th:text="${appt.departmentName}"></td>
                            <td th:text="${appt.roomName}"></td>
                            <td th:text="${#temporals.format(appt.appointmentDate, 'dd/MM/yyyy')} + ' ' + ${appt.appointmentTime}"></td>
                            <td th:text="${appt.appointmentType}"></td>
                            <td th:text="${appt.symptoms}"></td>
                            <td>
                                <span th:classappend="${appt.status == 'PENDING'} ? 'badge bg-warning' :
                                                      ${appt.status == 'CONFIRMED'} ? 'badge bg-success' :
                                                      ${appt.status == 'COMPLETED'} ? 'badge bg-info' : 'badge bg-danger'"
                                      th:text="${appt.status == 'PENDING'} ? 'Chờ xác nhận' :
                                                ${appt.status == 'CONFIRMED'} ? 'Đã xác nhận' :
                                                ${appt.status == 'COMPLETED'} ? 'Hoàn thành' : 'Đã hủy'"></span>
                            </td>
                            <td th:text="${#temporals.format(appt.createdAt, 'dd/MM/yyyy HH:mm')}"></td>
                            <td>
                                <a th:href="@{/admin/appointments/{id}/edit(id=${appt.id})}" class="btn btn-sm btn-warning">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a th:href="@{/admin/appointments/{id}/delete(id=${appt.id})}" class="btn btn-sm btn-danger" onclick="return confirm('Xác nhận xóa?')">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(appointments)}">
                            <td colspan="11" class="text-center text-muted">Chưa có lịch khám nào.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- JS riêng cho trang (DataTables + optional AJAX load phòng theo khoa) -->
<th:block th:fragment="extraScripts">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script th:inline="javascript">
        $(document).ready(function() {
            $('#appointmentTable').DataTable({
                "language": { "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/vi.json" },
                "order": [[5, "desc"]],  // Sort theo ngày giảm dần
                "pageLength": 10,
                responsive: true
            });
        });
    </script>
</th:block>